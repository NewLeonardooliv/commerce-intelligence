# Example GitHub Actions workflow for running agent evals
# Copy this file to .github/workflows/evals.yml to enable

name: Agent Evals

on:
  # Run on every push to main
  push:
    branches: [main, develop]
  
  # Run on every PR
  pull_request:
    branches: [main, develop]
  
  # Allow manual trigger
  workflow_dispatch:
    inputs:
      tags:
        description: 'Tags to filter tests (comma-separated)'
        required: false
        default: 'basic'
      report:
        description: 'Generate report (html, json, markdown, all)'
        required: false
        default: 'all'

jobs:
  # Quick smoke tests on every push
  quick-eval:
    name: Quick Eval (Basic Tests)
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest
      
      - name: Install dependencies
        run: bun install
      
      - name: Run basic evals
        run: bun src/tests/evals/cli.ts --tags=basic --verbose
        env:
          NODE_ENV: test
      
      - name: Check pass rate
        run: |
          # You can add custom logic here to fail if pass rate is too low
          echo "Basic tests completed"

  # Comprehensive tests (slower, only on main/develop)
  comprehensive-eval:
    name: Comprehensive Eval (All Tests)
    runs-on: ubuntu-latest
    timeout-minutes: 15
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest
      
      - name: Install dependencies
        run: bun install
      
      - name: Run all evals
        run: bun run test:evals:comprehensive
        env:
          NODE_ENV: test
      
      - name: Generate reports
        if: always()
        run: bun run evals:report
      
      - name: Upload HTML report
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: eval-reports
          path: reports/
          retention-days: 30
      
      - name: Comment PR with results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const reportPath = 'reports/orchestrator-eval-*.md';
            // Read and post markdown report as comment
            // (Implementation depends on your needs)

  # Interpreter-specific tests
  interpreter-eval:
    name: Interpreter Agent Eval
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
      
      - name: Install dependencies
        run: bun install
      
      - name: Run interpreter evals
        run: bun run test:evals:interpreter

  # Orchestrator-specific tests
  orchestrator-eval:
    name: Orchestrator E2E Eval
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
      
      - name: Install dependencies
        run: bun install
      
      - name: Run orchestrator evals
        run: bun run test:evals:orchestrator

  # Regression detection (compare with baseline)
  regression-check:
    name: Regression Check
    runs-on: ubuntu-latest
    timeout-minutes: 15
    if: github.event_name == 'pull_request'
    
    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
      
      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
      
      - name: Install dependencies
        run: bun install
      
      - name: Run evals and save results
        run: |
          bun src/tests/evals/cli.ts --all --report=json --output=./reports/pr
      
      - name: Checkout main branch
        uses: actions/checkout@v4
        with:
          ref: main
          path: baseline
      
      - name: Run baseline evals
        working-directory: baseline
        run: |
          bun install
          bun src/tests/evals/cli.ts --all --report=json --output=../reports/baseline
      
      - name: Compare results
        run: |
          # Add comparison script here
          echo "Comparing PR results with baseline"
          # If regression detected (score dropped >10%), fail the job
      
      - name: Upload comparison report
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: regression-report
          path: reports/

  # Scheduled full evaluation (nightly)
  nightly-eval:
    name: Nightly Full Evaluation
    runs-on: ubuntu-latest
    timeout-minutes: 30
    if: github.event_name == 'schedule'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
      
      - name: Install dependencies
        run: bun install
      
      - name: Run comprehensive evals
        run: bun run test:evals:comprehensive
      
      - name: Generate all reports
        if: always()
        run: bun run evals:report
      
      - name: Archive reports
        if: always()
        run: |
          mkdir -p archive
          mv reports/* archive/
          tar -czf evals-$(date +%Y%m%d).tar.gz archive/
      
      - name: Upload to S3 (or other storage)
        if: always()
        run: |
          # Upload to your preferred storage
          echo "Archiving reports..."
      
      - name: Send Slack notification
        if: always()
        uses: slackapi/slack-github-action@v1
        with:
          payload: |
            {
              "text": "Nightly eval completed",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "Nightly agent evaluation completed!"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

# Schedule nightly runs
on:
  schedule:
    # Run every day at 2 AM UTC
    - cron: '0 2 * * *'
